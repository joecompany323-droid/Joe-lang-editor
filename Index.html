<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JoeMaster Pro Studio</title>
    
    <!-- Core Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0d1117;
            --sidebar: #161b22;
            --accent: #3b82f6;
            --border: #30363d;
        }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: var(--bg-dark); 
            color: #c9d1d9; 
            margin: 0; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header { 
            background: var(--sidebar); 
            height: 60px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            .workspace { flex-direction: column; }
        }

        .editor-zone {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            background: #0d1117;
            border-left: 1px solid var(--border);
            position: relative;
        }

        #code-editor {
            flex: 1;
            background: transparent;
            color: #e6edf3;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            padding: 20px;
            resize: none;
            outline: none;
            border: none;
            direction: ltr;
            line-height: 1.5;
        }

        .preview-zone {
            flex: 1;
            background: #f0f2f5;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background: white;
            min-height: 80vh;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative;
        }
    </style>
</head>
<body>

<header>
    <div class="flex items-center gap-3">
        <div class="text-xl font-black text-white italic">JOE<span class="text-blue-500">MASTER</span></div>
        <span class="hidden md:inline text-[10px] bg-blue-500/10 text-blue-400 px-2 py-1 rounded border border-blue-500/20">v1.1.0 Stable</span>
    </div>
    <div class="flex gap-2">
        <button onclick="document.getElementById('import-file').click()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-2 rounded-xl font-bold text-xs transition-all">استيراد</button>
        <button onclick="exportSource()" class="bg-gray-800 hover:bg-gray-700 text-gray-300 px-3 py-2 rounded-xl font-bold text-xs transition-all">حفظ الكود</button>
        <button onclick="exportProject()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-bold text-sm transition-all active:scale-95">تصدير App</button>
        <button onclick="runJoeLang()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg transition-all active:scale-95">تشغيل</button>
        <input type="file" id="import-file" class="hidden" accept=".joe,.txt,.html" onchange="importJoeCode(event)">
    </div>
</header>

<div class="workspace">
    <div class="editor-zone">
        <div class="bg-[#161b22] px-4 py-2 border-b border-[#30363d] flex justify-between items-center">
            <span class="text-[11px] font-mono text-gray-400 uppercase tracking-widest">Main_Project.joe</span>
            <div class="flex gap-2">
                <button onclick="clearEditor()" class="text-[10px] text-red-400 hover:text-red-300 transition-colors uppercase font-bold">مسح المحرر</button>
                <div class="flex gap-1.5 ml-2">
                    <div class="w-2.5 h-2.5 rounded-full bg-red-500/20"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-yellow-500/20"></div>
                    <div class="w-2.5 h-2.5 rounded-full bg-green-500/20"></div>
                </div>
            </div>
        </div>
        <textarea id="code-editor" spellcheck="false" placeholder="// ابدأ بكتابة كود JoeLang هنا..."></textarea>
        <div class="p-3 bg-[#0d1117] border-t border-[#30363d] flex justify-between items-center">
            <p class="text-[10px] text-gray-500">تم التعرف على مفسر JoeLang v1.1</p>
            <div class="flex gap-4">
                <span id="char-count" class="text-[10px] text-gray-500">حروف: 0</span>
                <button onclick="copyToClipboard()" class="text-[10px] text-blue-400 hover:underline">نسخ الكود المصدري</button>
            </div>
        </div>
    </div>

    <div class="preview-zone">
        <div class="app-container" id="app-viewport"></div>
    </div>
</div>

<script>
/**
 * JoeLang Engine Implementation
 */
class JoeLang {
    constructor() {
        this.config = {
            apiKey: "AIzaSyDk5XDcDnBrhNo2TR4ZNF4_c5i8FKhlJQc",
            authDomain: "commerce-flow-e8860.firebaseapp.com",
            projectId: "commerce-flow-e8860",
            appId: "1:946951336268:web:cd7d998d244f5c5af49fe9"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(this.config);
        }
        
        this.auth = firebase.auth();
        this.db = firebase.firestore();
        this.pages = new Map();
        this.container = null;
    }

    load(code) {
        const lines = code.split('\n');
        let currentPageName = null;
        let pageElements = [];
        let theme = "#4f46e5";
        let nextRedirect = "";

        this.pages.clear();

        lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed || trimmed.startsWith('//')) return;

            const idx = trimmed.indexOf(':');
            if (idx === -1) return;

            const command = trimmed.substring(0, idx).trim();
            const value = trimmed.substring(idx + 1).trim();

            if (command === 'صفحة') {
                if (currentPageName) {
                    this.pages.set(currentPageName, { elements: [...pageElements], theme, next: nextRedirect });
                }
                currentPageName = value;
                pageElements = [];
                nextRedirect = "";
            } else if (command === 'ثيم') {
                theme = value;
            } else if (command === 'بعد_الدخول') {
                nextRedirect = value;
            } else {
                pageElements.push({ command, value });
            }
        });

        if (currentPageName) {
            this.pages.set(currentPageName, { elements: pageElements, theme, next: nextRedirect });
        }
    }

    start(containerId, startPage = 'الرئيسية') {
        this.container = document.getElementById(containerId);
        const keys = Array.from(this.pages.keys());
        const actualStart = this.pages.has(startPage) ? startPage : keys[0];
        if (actualStart) this.render(actualStart);
    }

    async render(pageName) {
        const page = this.pages.get(pageName);
        if (!page) return;

        this.container.innerHTML = '';
        const wrapper = document.createElement('div');
        wrapper.className = 'animate__animated animate__fadeIn';
        wrapper.style.cssText = `direction: rtl; padding: 25px; text-align: right;`;

        const state = {};

        for (const item of page.elements) {
            const el = this._createElement(item, page.theme, state, page.next);
            if (el) wrapper.appendChild(el);
        }

        this.container.appendChild(wrapper);
    }

    _createElement({ command, value }, theme, state, next) {
        const div = document.createElement('div');
        div.className = "mb-5";

        switch (command) {
            case 'عنوان':
                div.innerHTML = `<h1 style="color:${theme}; font-size:26px; font-weight:900;">${value}</h1>`;
                break;
            case 'نص':
                div.innerHTML = `<p class="text-gray-500 leading-relaxed">${value}</p>`;
                break;
            case 'صورة':
                div.innerHTML = `<img src="${value}" class="w-full rounded-2xl shadow-lg border-4 border-white">`;
                break;
            case 'مدخل':
            case 'مدخل_سري':
                const inp = document.createElement('input');
                inp.placeholder = value;
                inp.type = command === 'مدخل_سري' ? 'password' : 'text';
                inp.className = "w-full p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all";
                inp.oninput = (e) => state[value] = e.target.value;
                div.appendChild(inp);
                break;
            case 'انتقل':
                div.appendChild(this._btn(value, theme, () => this.render(value)));
                break;
            case 'زر_دخول':
                div.appendChild(this._btn(value, "#1f2937", async () => {
                    const email = Object.values(state).find(v => v.includes('@'));
                    const pass = Object.values(state).find(v => v.length >= 6);
                    try {
                        await this.auth.signInWithEmailAndPassword(email, pass);
                        if(next) this.render(next); else alert("تم الدخول");
                    } catch(e) { alert("خطأ: " + e.message); }
                }));
                break;
            case 'زر_حساب_جديد':
                div.appendChild(this._btn(value, theme, async () => {
                    const email = Object.values(state).find(v => v.includes('@'));
                    const pass = Object.values(state).find(v => v.length >= 6);
                    try {
                        const res = await this.auth.createUserWithEmailAndPassword(email, pass);
                        await this.db.collection("users").doc(res.user.uid).set({ email, uid: res.user.uid });
                        if(next) this.render(next); else alert("تم التسجيل");
                    } catch(e) { alert("خطأ: " + e.message); }
                }));
                break;
        }
        return div;
    }

    _btn(text, bg, action) {
        const b = document.createElement('button');
        b.innerText = text;
        b.onclick = action;
        b.className = "w-full p-4 rounded-xl text-white font-bold shadow-md active:scale-95 transition-all";
        b.style.backgroundColor = bg;
        return b;
    }
}

const joe = new JoeLang();
const editor = document.getElementById('code-editor');
const charCount = document.getElementById('char-count');

editor.addEventListener('input', () => {
    charCount.innerText = `حروف: ${editor.value.length}`;
});

function runJoeLang() {
    joe.load(editor.value);
    joe.start('app-viewport');
}

function clearEditor() {
    if(confirm("هل أنت متأكد من مسح كافة الكود؟")) {
        editor.value = "";
        charCount.innerText = "حروف: 0";
    }
}

function importJoeCode(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        editor.value = e.target.result;
        charCount.innerText = `حروف: ${editor.value.length}`;
        runJoeLang();
    };
    reader.readAsText(file);
}

function exportSource() {
    const blob = new Blob([editor.value], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'project.joe';
    a.click();
}

function exportProject() {
    const code = editor.value;
    const safeCode = btoa(unescape(encodeURIComponent(code)));
    
    const html = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيقي الذكي</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"><\/script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"><\/script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"><\/script>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f0f2f5; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        #app-root { width: 100%; max-width: 450px; background: white; border-radius: 24px; min-height: 80vh; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
    </style>
</head>
<body>
    <div id="app-root"></div>
    <script>
        const SOURCE = decodeURIComponent(escape(atob("${safeCode}")));
        ${JoeLang.toString()}
        const engine = new JoeLang();
        engine.load(SOURCE);
        engine.start('app-root');
    <\/script>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'JoeApp_Build.html';
    a.click();
}

function copyToClipboard() {
    editor.select();
    document.execCommand('copy');
    alert('تم نسخ الكود بنجاح');
}

// الكود الافتراضي
editor.value = `// مثال تطبيق JoeLang متكامل
صفحة: الرئيسية
ثيم: #3b82f6
عنوان: استوديو جو ماستر
نص: مرحباً بك في مفسر اللغة العربية المطور.
صورة: https://images.unsplash.com/photo-1614850523296-d8c1af93d400?w=500
انتقل: تسجيل_الدخول

صفحة: تسجيل_الدخول
ثيم: #6366f1
عنوان: دخول المستخدم
مدخل: البريد الإلكتروني
مدخل_سري: كلمة المرور
بعد_الدخول: الرئيسية
زر_دخول: تسجيل الدخول
انتقل: الرئيسية`;

if (window.location.pathname !== "/") {
    window.history.replaceState(null, "", "/");
}

window.onload = runJoeLang;
</script>
</body>
</html>

